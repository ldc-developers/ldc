name: Build LDC with PGO instrumentation & gather profile from compiling default libs
inputs:
  extra_d_flags: # applying to the D executables, not the runtime
    required: false
    default: ''
  lto_mode: # full | thin | none
    required: false
    default: full
  arch:
    required: false # Windows only
runs:
  using: composite
  steps:

    - name: Build LDC with PGO instrumentation & gather profiles from compiling default libs
      uses: ./.github/actions/helper-build-ldc
      with:
        build_dir: pgo-ldc
        host_dc: ../bootstrap-ldc/bin/ldmd2
        # tweak -vp-counters-per-site to avoid `LLVM Profile Warning: Unable to track new values: Running out of static counters.`
        cmake_flags: >-
          -DBUILD_SHARED_LIBS=OFF
          "-DCMAKE_C_COMPILER=${{ runner.os != 'Windows' && '$PWD/../clang/bin/clang' || 'clang-cl' }}"
          "-DCMAKE_CXX_COMPILER=${{ runner.os != 'Windows' && '$PWD/../clang/bin/clang++' || 'clang-cl' }}"
          "-DDFLAGS_LDC=-fprofile-generate -vp-counters-per-site=1.5"
        extra_d_flags: ${{ inputs.extra_d_flags }}
        extra_cxx_flags: -fprofile-generate -mllvm -vp-counters-per-site=1.5
        lto_mode: ${{ inputs.lto_mode }}
        arch: ${{ inputs.arch }}
      env:
        LLVM_PROFILE_FILE: ${{ github.workspace }}/../pgo-ldc/%p.profraw

    - name: Merge PGO profiles # to ../pgo-ldc/merged.profdata
      shell: bash
      run: |
        set -eux
        cd ../pgo-ldc
        ../bootstrap-ldc/bin/ldc-profdata merge --output=merged.profdata *.profraw
        ls -lh *.prof{data,raw}

version: v1.0
name: LDC
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
  - name: "Semaphore 2.0"
    task:
      env_vars:
        - name: HOST_LDC_VERSION
          value: "1.14.0"
      jobs:
        - name: Build and test
          commands:
            - checkout || true
            - git submodule update --init
            # Install prerequisites
            - export DEBIAN_FRONTEND=noninteractive
            - sudo dpkg --add-architecture i386
            - sudo apt-get -q update
            - |
              sudo apt-get -yq install \
                cmake ninja-build g++-multilib \
                llvm-dev zlib1g-dev libclang-common-6.0-dev \
                libcurl4 libcurl4:i386 \
                curl gdb python-pip tzdata unzip zip
            - export CC="gcc-7"
            - export CXX="g++-7"
            - sudo update-alternatives --install /usr/bin/ld ld /usr/bin/ld.gold 99
            - pip install --user lit
            - python -c "import lit; lit.main();" --version | head -n 1
            - curl -L -o ldc2.tar.xz https://github.com/ldc-developers/ldc/releases/download/v$HOST_LDC_VERSION/ldc2-$HOST_LDC_VERSION-linux-x86_64.tar.xz
            - mkdir host-ldc
            - tar -xf ldc2.tar.xz --strip 1 -C host-ldc
            - rm ldc2.tar.xz
            # Build LDC & LDC D unittests & defaultlib unittest runners
            - cmake --version
            - ninja --version
            - mkdir build
            - cd build
            - |
              cmake -G Ninja .. \
                -DCMAKE_BUILD_TYPE=Release \
                -DD_COMPILER=$PWD/../host-ldc/bin/ldmd2 \
                -DMULTILIB=ON \
                -DLDC_INSTALL_LTOPLUGIN=ON \
                -DLDC_INSTALL_LLVM_RUNTIME_LIBS=ON
            - ninja -j2 all ldc2-unittest all-test-runners
            - bin/ldc2 -version
            # Run LDC D unittests
            - ctest --output-on-failure -R ldc2-unittest
            # Run LIT testsuite
            - ctest -V -R lit-tests
            # Run DMD testsuite
            - DMD_TESTSUITE_MAKE_ARGS=-j4 ctest -V -R dmd-testsuite
            # Run defaultlib unittests & druntime stand-alone tests
            - ctest -j4 --output-on-failure -E "ldc2-unittest|lit-tests|dmd-testsuite"
